<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tiroid Papiller Karsinom Rapor Oluşturucu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
      :root{
        --background-color:#f8f9fa; --panel-background:#ffffff; --text-color:#212529;
        --primary-color:#007bff; --primary-hover-color:#0056b3; --border-color:#dee2e6;
        --input-background:#ffffff; --button-background:#f8f9fa; --button-hover-background:#e2e6ea;
        --danger-color:#dc3545; --danger-hover-color:#c82333;
        --focus-a:#f6f9ff; --focus-b:#fff7e8;
        --font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      }
      *{box-sizing:border-box}
      body{margin:0;background:var(--background-color);color:var(--text-color);font-family:var(--font-family)}
      .container{display:flex;flex-direction:column;height:100vh}
      .app-header{background:var(--panel-background);padding:16px 24px;border-bottom:1px solid var(--border-color);box-shadow:0 2px 4px rgba(0,0,0,.05)}
      .app-header h1{margin:0 0 8px 0;font-size:1.5em;color:#343a40}
      .app-header p{margin:0;font-size:.9em;color:#6c757d}
      /* GLOBAL TOP BAR just under header */
      .topbar-global{
        position:sticky; top:0; z-index:9; background:#f8f9fa;
        border-bottom:1px solid var(--border-color);
        padding:10px 16px;
      }
      .chips-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
      .chips-section-title{font-size:12px;color:#6c757d;margin-right:6px}
      .chip{border:1px solid var(--border-color);padding:6px 10px;border-radius:999px;background:#fff;font-size:12px;cursor:pointer}
      .chip:hover{background:var(--button-hover-background)}
      .chip.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}
      .sep{width:1px;height:20px;background:var(--border-color);margin:0 8px}

      .main-content{display:flex;flex:1;overflow:hidden}
      .panel{padding:20px;overflow-y:auto;height:calc(100vh - 95px)}
      #controls-panel{width:45%;border-right:1px solid var(--border-color);background:#f8f9fa}
      #report-container{width:55%;display:flex;flex-direction:column}
      .report-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}
      .report-header h2{margin:0;font-size:1.2em}
      #report-preview{flex-grow:1;background:#f1f3f5;border:1px solid var(--border-color);border-radius:4px;padding:16px;font-family:'SFMono-Regular',Consolas,'Liberation Mono',Menlo,Courier,monospace;font-size:.95em;line-height:1.6;white-space:pre-wrap}

      .control-group{margin-bottom:24px;padding:16px;border:1px solid var(--border-color);border-radius:8px;background:var(--panel-background)}
      .control-group h3{margin:0 0 16px 0;font-size:1.1em;color:#495057;padding-bottom:10px;border-bottom:1px solid var(--border-color)}
      .form-row{display:flex;flex-wrap:wrap;gap:16px;margin-bottom:12px;align-items:center}
      .form-field{flex:1;min-width:150px;display:flex;flex-direction:column}
      .form-field.small{min-width:100px;flex:.5}
      .form-field label{margin-bottom:6px;font-size:.9em;color:#495057;font-weight:500}
      input[type="text"],input[type="number"],select,textarea{width:100%;background:var(--input-background);color:var(--text-color);border:1px solid #ced4da;padding:8px 10px;border-radius:4px;font-size:.9em;transition:border-color .2s,box-shadow .2s}
      input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 2px rgba(0,123,255,.25)}
      button{background:var(--button-background);color:var(--text-color);border:1px solid #ced4da;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;transition:background-color .2s,border-color .2s;display:inline-flex;align-items:center;gap:6px}
      button:hover{background:var(--button-hover-background);border-color:#adb5bd}
      button.primary,#copy-report-btn{background:var(--primary-color);border-color:var(--primary-color);color:#fff}
      button.primary:hover,#copy-report-btn:hover{background:var(--primary-hover-color);border-color:var(--primary-hover-color)}
      button.danger{background:var(--danger-color);border-color:var(--danger-color);color:#fff}
      button.danger:hover{background:var(--danger-hover-color);border-color:var(--danger-hover-color)}
      .toggle-buttons{display:flex;flex-wrap:wrap;gap:8px}
      .toggle-btn{background:var(--button-background);border:1px solid #ced4da}
      .toggle-btn.active{background:var(--danger-color);border-color:var(--danger-color);color:#fff}

      .tumor-focus,.ln-focus{border:1px solid #e9ecef;padding:16px;margin-top:16px;border-radius:6px}
      .tumor-focus.focus-a,.ln-focus.focus-a{background:var(--focus-a)}
      .tumor-focus.focus-b,.ln-focus.focus-b{background:var(--focus-b)}
      .tumor-focus-header,.ln-focus-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
      .tumor-focus-header h4,.ln-focus-header h4{margin:0;font-size:1.05em}

      /* Scrollbar */
      ::-webkit-scrollbar{width:10px} ::-webkit-scrollbar-track{background:#e9ecef}
      ::-webkit-scrollbar-thumb{background:#adb5bd;border-radius:5px} ::-webkit-scrollbar-thumb:hover{background:#6c757d}
    </style>
  </head>
  <body>
    <div class="container">
      <header class="app-header">
        <h1>Tiroid Papiller Karsinom Rapor Oluşturucu</h1>
        <p>Raporu oluşturmak için sol paneldeki seçenekleri kullanın. Rapor sağ tarafta anlık olarak güncellenecektir.</p>
      </header>

      <!-- GLOBAL TOP BAR (başlığın hemen altında) -->
      <div id="topbar-global" class="topbar-global">
        <div class="chips-row">
          <span class="chips-section-title">Tümör Odakları</span>
          <div id="tumor-chips"></div>
          <div class="sep"></div>
          <span class="chips-section-title">LN</span>
          <div id="ln-chips"></div>
        </div>
      </div>

      <main class="main-content">
        <div id="controls-panel" class="panel"></div>
        <div id="report-container" class="panel">
          <div class="report-header">
            <h2>Rapor Önizlemesi</h2>
            <button id="copy-report-btn" title="Raporu Kopyala"><i class="fa-solid fa-copy"></i> Kopyala</button>
          </div>
          <pre id="report-preview"></pre>
        </div>
      </main>
    </div>

    <script>
      // ------------ STATE ------------
      let state = {
        specimenType: 'Total Tiroidektomi',
        tumors: [{
          id: 1,
          location: 'Sağ lob',
          size: 5,
          sample: '', // boş başlar
          subtypes: ['Klasik papiller karsinom'],
          encapsulation: 'Yoktur',
          extrathyroidalExtension: false,
          lvInvasion: 'yoktur',
          lymphaticInvasion: false,
          angioinvasion: false,
          perineuralInvasion: false,
          mitoticActivity: '0',
          necrosis: false
        }],
        globalFindings: { surgicalMargins: false },
        lymphNodes: [],  // {id, location, metastatic, total, pericapsularInvasion}
        backgroundThyroid: ['Nodüler guatr'],
        freeNote: '',
        activeTumorId: 1,
        activeLnId: null
      };

      const HISTOLOGIC_SUBTYPES = [
        'Klasik papiller karsinom','İnfiltratif foliküler alt tip','Onkositik papiller alt tip',
        'Warthin benzeri alt tip','Tall cell alt tip','Hobnail alt tip','Solid alt tip','NIFTP','Diffüz sklerozan alt tip'
      ];
      const BACKGROUND_THYROID_OPTIONS = [
        'Nodüler guatr','Fokal lenfositik tiroidit','Yaygın lenfositik tiroidit','Hashimoto tiroiditi','Kolloidden zengin'
      ];

      // ------------ DOM ------------
      const controlsPanel = document.getElementById('controls-panel');
      const reportPreview = document.getElementById('report-preview');
      const copyReportBtn = document.getElementById('copy-report-btn');
      const tumorChipsWrap = document.getElementById('tumor-chips');
      const lnChipsWrap = document.getElementById('ln-chips');

      // ------------ UTILS ------------
      function createElement(tag, opts){
        const el = document.createElement(tag);
        if (opts && 'className' in opts) el.className = opts.className;
        if (opts && 'textContent' in opts) el.textContent = opts.textContent;
        if (opts && 'innerHTML' in opts) el.innerHTML = opts.innerHTML;
        if (opts && 'id' in opts) el.id = opts.id;
        return el;
      }
      function topbarHeight(){
        const tb = document.getElementById('topbar-global');
        return tb ? tb.offsetHeight : 0;
      }
      function scrollChildToTop(container, child){
        if (!container || !child) return;
        const cTop = container.getBoundingClientRect().top;
        const offset = child.getBoundingClientRect().top - cTop + container.scrollTop - (topbarHeight() + 8);
        container.scrollTo({ top: Math.max(0, offset), behavior: 'smooth' });
      }
      function collapseTripleNewlines(text){
        while (text.indexOf('\n\n\n') !== -1) text = text.replace('\n\n\n','\n\n');
        return text;
      }
      function setActiveTumorChip(id){
        Array.from(tumorChipsWrap.querySelectorAll('.chip')).forEach(ch=>{
          ch.classList.toggle('active', String(ch.dataset.tid)===String(id));
        });
        state.activeTumorId = id;
      }
      function setActiveLnChip(id){
        Array.from(lnChipsWrap.querySelectorAll('.chip')).forEach(ch=>{
          ch.classList.toggle('active', String(ch.dataset.lid)===String(id));
        });
        state.activeLnId = id;
      }
      function scrollToTumorIdEnsure(id){
        const card = document.getElementById('tumor-card-' + id);
        if (!card) return;
        setActiveTumorChip(id);
        scrollChildToTop(controlsPanel, card);
      }
      function scrollToLnIdEnsure(id){
        const card = document.getElementById('ln-card-' + id);
        if (!card) return;
        setActiveLnChip(id);
        scrollChildToTop(controlsPanel, card);
      }

      let scrollListenerAttached = false;
      let scrollRAF = null;
      function getNearestTumorIdToTop(){
        const cTop = controlsPanel.getBoundingClientRect().top + topbarHeight() + 8;
        let bestId = state.tumors.length ? state.tumors[0].id : null;
        let bestDist = Infinity;
        state.tumors.forEach(t => {
          const el = document.getElementById('tumor-card-' + t.id);
          if (!el) return;
          const d = Math.abs(el.getBoundingClientRect().top - cTop);
          if (d < bestDist){ bestDist = d; bestId = t.id; }
        });
        return bestId;
      }
      function attachScrollListenerOnce(){
        if (scrollListenerAttached) return;
        scrollListenerAttached = true;
        controlsPanel.addEventListener('scroll', () => {
          if (scrollRAF) return;
          scrollRAF = requestAnimationFrame(() => {
            scrollRAF = null;
            const id = getNearestTumorIdToTop();
            if (id != null) setActiveTumorChip(id);
          });
        });
      }

      // ------------ CHIPS (GLOBAL BAR) ------------
      function renderChips(){
        // Tumor chips
        tumorChipsWrap.innerHTML = '';
        state.tumors.forEach((t, i) => {
          const chip = createElement('button', {
            className: 'chip' + (state.activeTumorId === t.id ? ' active' : ''),
            textContent: (i + 1) + '. Tümör'
          });
          chip.dataset.tid = String(t.id);
          chip.addEventListener('click', ()=> scrollToTumorIdEnsure(t.id));
          tumorChipsWrap.appendChild(chip);
        });

        // LN chips
        lnChipsWrap.innerHTML = '';
        state.lymphNodes.forEach((ln, i) => {
          const name = (ln.location ? ln.location + ' ' : '') + (i+1) + '. LN';
          const chip = createElement('button', {
            className: 'chip' + (state.activeLnId === ln.id ? ' active' : ''),
            textContent: name.trim()
          });
          chip.dataset.lid = String(ln.id);
          chip.addEventListener('click', ()=> scrollToLnIdEnsure(ln.id));
          lnChipsWrap.appendChild(chip);
        });
      }

      // ------------ RENDER CONTROLS ------------
      function renderControls(){
        controlsPanel.innerHTML = '';

        // Tanı Bilgileri
        const specimenGroup = createControlGroup('Tanı Bilgileri');
        const specimenSelect = createSelect('specimenType','Materyal Tipi',
          ['Total Tiroidektomi','Konsültasyon, Total tiroidektomi'], state.specimenType);
        specimenSelect.addEventListener('change', e => { state.specimenType = e.target.value; renderReport(); });
        specimenGroup.appendChild(specimenSelect);

        const noteField = createTextarea('diagnosis-note','Tanı altına not (serbest yazı)', state.freeNote || '');
        noteField.querySelector('textarea').addEventListener('input', e => { state.freeNote = e.target.value; renderReport(); });
        specimenGroup.appendChild(noteField);
        controlsPanel.appendChild(specimenGroup);

        // Tümör Odakları
        const tumorsGroup = createControlGroup('Tümör Odakları');
        state.tumors.forEach((tumor, index) => {
          tumorsGroup.appendChild(createTumorFocusControl(tumor, index));
        });
        const addTumorBtn = createElement('button', { className:'primary', innerHTML:'<i class="fa-solid fa-plus"></i> Tümör Odağı Ekle' });
        addTumorBtn.addEventListener('click', () => {
          const newId = Date.now();
          state.tumors.push({
            id:newId, location:'Sol lob', size:3, sample:'',
            subtypes:['Klasik papiller karsinom'], encapsulation:'Yoktur',
            extrathyroidalExtension:false, lvInvasion:'yoktur',
            lymphaticInvasion:false, angioinvasion:false,
            perineuralInvasion:false, mitoticActivity:'0', necrosis:false
          });
          state.activeTumorId = newId;
          render();            // DOM & chips güncellenir
          requestAnimationFrame(()=>requestAnimationFrame(()=>{
            scrollToTumorIdEnsure(newId);
            const sampleEl = document.getElementById('tumor-sample-' + newId);
            if (sampleEl) sampleEl.focus();
          }));
        });
        tumorsGroup.appendChild(addTumorBtn);
        controlsPanel.appendChild(tumorsGroup);

        // Lenf Nodu Durumu
        const lnGroup = createControlGroup('Lenf Nodu Durumu');
        state.lymphNodes.forEach((ln, index) => {
          lnGroup.appendChild(createLymphNodeControl(ln, index));
        });
        const addLNBtn = createElement('button', { className:'primary', innerHTML:'<i class="fa-solid fa-plus"></i> Lenf Nodu Grubu Ekle' });
        addLNBtn.addEventListener('click', () => {
          const id = Date.now();
          state.lymphNodes.push({ id, location:'', metastatic:0, total:1, pericapsularInvasion:false });
          state.activeLnId = id;
          render();            // DOM & chips güncellenir
          requestAnimationFrame(()=>requestAnimationFrame(()=>{
            scrollToLnIdEnsure(id);
            const locEl = document.getElementById('ln-location-' + id);
            if (locEl) locEl.focus();
          }));
        });
        lnGroup.appendChild(addLNBtn);
        controlsPanel.appendChild(lnGroup);

        // Tümör dışı tiroid
        const backgroundGroup = createControlGroup('Tümör Dışı Tiroid');
        const backgroundCheckboxes = createCheckboxGroup('Bulgular', BACKGROUND_THYROID_OPTIONS, state.backgroundThyroid, (sel) => {
          state.backgroundThyroid = sel; renderReport();
        });
        backgroundGroup.appendChild(backgroundCheckboxes);
        controlsPanel.appendChild(backgroundGroup);
      }

      function createTumorFocusControl(tumor, index){
        const container = createElement('div', {
          className: 'tumor-focus ' + (index % 2 === 0 ? 'focus-a' : 'focus-b'),
          id: 'tumor-card-' + tumor.id
        });

        const header = createElement('div', { className:'tumor-focus-header' });
        header.appendChild(createElement('h4', { textContent: (index + 1) + '. Odak' }));
        const removeBtn = createElement('button', { className:'danger', innerHTML:'<i class="fa-solid fa-trash-alt"></i>' });
        removeBtn.addEventListener('click', () => {
          if (state.tumors.length > 1){
            state.tumors.splice(index, 1);
            if (!state.tumors.find(t => t.id === state.activeTumorId)) {
              state.activeTumorId = state.tumors.length ? state.tumors[state.tumors.length-1].id : null;
            }
            render();
          }
        });
        if (state.tumors.length <= 1) removeBtn.setAttribute('disabled','true');
        header.appendChild(removeBtn);
        container.appendChild(header);

        const row1 = createElement('div', { className:'form-row' });

        const locationSelect = createSelect('tumor-location-' + tumor.id, 'Yerleşim', ['', 'Sağ lob','Sol lob','İstmus'], tumor.location);
        locationSelect.addEventListener('change', e => { tumor.location = e.target.value; renderReport(); });
        row1.appendChild(locationSelect);

        const sizeInput = createInput('tumor-size-' + tumor.id, 'Çap (mm)', 'number', String(tumor.size));
        sizeInput.addEventListener('input', e => { tumor.size = Number(e.target.value || 0); renderReport(); });
        row1.appendChild(sizeInput);

        const sampleInput = createInput('tumor-sample-' + tumor.id, 'Örnek No', 'text', tumor.sample);
        const sampleEl = sampleInput.querySelector('input');
        sampleEl.setAttribute('maxlength','25'); // placeholder yok
        sampleEl.addEventListener('input', e => { tumor.sample = e.target.value; renderReport(); });
        row1.appendChild(sampleInput);

        container.appendChild(row1);

        const subtypeSelect = createSelect('tumor-subtypes-' + tumor.id, 'Histolojik Alt Tip', HISTOLOGIC_SUBTYPES, tumor.subtypes[0]);
        subtypeSelect.addEventListener('change', e => { tumor.subtypes = [e.target.value]; renderReport(); });
        container.appendChild(subtypeSelect);

        const findingsContainer = createElement('div', { className:'tumor-findings' });
        findingsContainer.appendChild(createToggleButtons('Enkapsülasyon', ['Yoktur','VARDIR','Kısmen VARDIR'], tumor.encapsulation, (val) => { tumor.encapsulation = val; render(); }));
        findingsContainer.appendChild(createBooleanToggle('Tiroid dışı invazyon', tumor.extrathyroidalExtension, (v) => { tumor.extrathyroidalExtension = v; render(); }));

        const lviContainer = createElement('div', { className:'lvi-container' });
        const lviButtons = createToggleButtons('Lenfatik ve/veya venöz invazyon', ['yoktur','VARDIR','kuşkulu VARDIR'], tumor.lvInvasion, (val) => {
          tumor.lvInvasion = val;
          if (val !== 'VARDIR'){ tumor.lymphaticInvasion = false; tumor.angioinvasion = false; }
          render();
        });
        lviContainer.appendChild(lviButtons);

        if (tumor.lvInvasion === 'VARDIR'){
          const sub = createElement('div', { className:'sub-findings' });
          sub.appendChild(createBooleanToggle('Lenfatik invazyon', tumor.lymphaticInvasion, (v) => { tumor.lymphaticInvasion = v; render(); }));
          sub.appendChild(createBooleanToggle('Anjioinvazyon', tumor.angioinvasion, (v) => { tumor.angioinvasion = v; render(); }));
          lviContainer.appendChild(sub);
        }
        findingsContainer.appendChild(lviContainer);

        findingsContainer.appendChild(createBooleanToggle('Perinöral invazyon', tumor.perineuralInvasion, (v) => { tumor.perineuralInvasion = v; render(); }));

        const mitoticInput = createInput('tumor-mitosis-' + tumor.id, 'Mitotik Oran (/ 2 mm²)', 'text', tumor.mitoticActivity);
        mitoticInput.querySelector('input').addEventListener('input', e => { tumor.mitoticActivity = e.target.value.replace(/[^0-9]/g,''); renderReport(); });
        findingsContainer.appendChild(mitoticInput);

        findingsContainer.appendChild(createBooleanToggle('Nekroz', tumor.necrosis, (v) => { tumor.necrosis = v; render(); }));

        container.appendChild(document.createElement('hr'));
        container.appendChild(findingsContainer);
        return container;
      }

      function createLymphNodeControl(ln, index){
        const container = createElement('div', {
          className: 'ln-focus ' + (index % 2 === 0 ? 'focus-a' : 'focus-b'),
          id: 'ln-card-' + ln.id
        });
        const header = createElement('div', { className:'ln-focus-header' });
        header.appendChild(createElement('h4', { textContent: (index + 1) + '. Lenf Nodu Grubu' }));
        const removeBtn = createElement('button', { className:'danger', innerHTML:'<i class="fa-solid fa-trash-alt"></i>' });
        removeBtn.addEventListener('click', () => {
          state.lymphNodes.splice(index, 1);
          if (!state.lymphNodes.find(x => x.id === state.activeLnId)) state.activeLnId = state.lymphNodes.length ? state.lymphNodes[state.lymphNodes.length-1].id : null;
          render();
        });
        header.appendChild(removeBtn);
        container.appendChild(header);

        const row1 = createElement('div', { className:'form-row' });

        const locationInput = createInput('ln-location-' + ln.id, 'Yerleşim', 'text', ln.location || '');
        locationInput.addEventListener('input', e => { ln.location = e.target.value; renderReport(); });
        row1.appendChild(locationInput);

        const metastaticInput = createInput('ln-meta-' + ln.id, 'Metastatik', 'number', String(ln.metastatic));
        metastaticInput.classList.add('small');
        metastaticInput.addEventListener('input', e => { ln.metastatic = Number(e.target.value || 0); renderReport(); });
        row1.appendChild(metastaticInput);

        const totalInput = createInput('ln-total-' + ln.id, 'Toplam', 'number', String(ln.total));
        totalInput.classList.add('small');
        totalInput.addEventListener('input', e => { ln.total = Number(e.target.value || 0); renderReport(); });
        row1.appendChild(totalInput);

        container.appendChild(row1);

        // Sağlam yaklaşım: toggle kendi UI'sını anında günceller + state'i set eder; ardından tüm UI senkron kalsın diye render()
        container.appendChild(
          createBooleanToggle(
            'Perikapsüler invazyon',
            ln.pericapsularInvasion,
            (v)=>{ ln.pericapsularInvasion = v; render(); },
            'Var', 'Yok'
          )
        );

        return container;
      }

      // ------------ COMPONENTS ------------
      function createControlGroup(title){
        const g = createElement('div', { className:'control-group' });
        g.appendChild(createElement('h3', { textContent:title }));
        return g;
      }
      function createInput(id,label,type,value){
        const f = createElement('div', { className:'form-field' });
        f.appendChild(createElement('label', { textContent:label }));
        const input = createElement('input', { id:id });
        input.type = type;
        input.value = value;
        if (type === 'number') input.min = '0';
        f.appendChild(input);
        return f;
      }
      function createTextarea(id,label,value){
        const f = createElement('div', { className:'form-field' });
        f.appendChild(createElement('label', { textContent:label }));
        const ta = document.createElement('textarea');
        ta.id = id; ta.rows = 3; ta.value = value || '';
        f.appendChild(ta);
        return f;
      }
      function createSelect(id,label,options,selected){
        const f = createElement('div', { className:'form-field' });
        f.appendChild(createElement('label', { textContent:label }));
        const sel = createElement('select', { id:id });
        options.forEach(opt => {
          const o = createElement('option', { textContent:opt });
          o.value = opt;
          if (opt === selected) o.selected = true;
          sel.appendChild(o);
        });
        f.appendChild(sel);
        return f;
      }
      // *** SAĞLAM YAKLAŞIM ***
      function createBooleanToggle(label,value,onChange,trueText='VARDIR',falseText='yoktur'){
        const c = createElement('div', { className:'form-field' });
        c.appendChild(createElement('label', { textContent:label }));
        const btn = createElement('button', { className:'toggle-btn ' + (value ? 'active' : ''), textContent: (value ? trueText : falseText) });
        btn.addEventListener('click', () => {
          value = !value;                              // lokal state
          btn.classList.toggle('active', value);       // UI anında
          btn.textContent = value ? trueText : falseText;
          onChange(value);                              // global state
        });
        c.appendChild(btn);
        return c;
      }
      function createToggleButtons(label, options, value, onChange){
        const c = createElement('div', { className:'form-field' });
        c.appendChild(createElement('label', { textContent:label }));
        const g = createElement('div', { className:'toggle-buttons' });
        options.forEach(opt => {
          const b = createElement('button', { className:'toggle-btn ' + (value === opt ? 'active' : ''), textContent:opt });
          b.addEventListener('click', () => onChange(opt));
          g.appendChild(b);
        });
        c.appendChild(g);
        return c;
      }
      function createCheckboxGroup(label, options, selected, onChange){
        const c = createElement('div', { className:'form-field' });
        c.appendChild(createElement('label', { textContent:label }));
        const box = createElement('div', { className:'checkbox-group' });
        options.forEach(opt => {
          const wrap = createElement('div', { className:'checkbox-wrapper' });
          const cb = document.createElement('input'); cb.type='checkbox';
          const safeId = 'bg-thyroid-' + opt.replace(/[^a-zA-Z0-9]/g,'-'); cb.id = safeId; cb.value = opt; cb.checked = selected.includes(opt);
          cb.addEventListener('change', e => {
            const checked = e.target.checked;
            const val = e.target.value;
            const ns = checked ? [...selected, val] : selected.filter(o => o !== val);
            onChange(ns);
          });
          const lab = createElement('label', { textContent:opt }); lab.htmlFor = safeId;
          wrap.appendChild(cb); wrap.appendChild(lab); box.appendChild(wrap);
        });
        c.appendChild(box);
        return c;
      }

      // ------------ REPORT ------------
      function getTumorDiagnosisName(size){ return size > 10 ? 'Tiroid papiller karsinom' : 'Tiroid papiller mikrokarsinom'; }
      function generateFindingsText(t, indent){
        indent = indent || '';
        let text = '';
        text += indent + 'Tümörde enkapsülasyon: ' + t.encapsulation + '\n';
        text += indent + 'Tiroid dışı invazyon: ' + (t.extrathyroidalExtension ? 'VARDIR' : 'yoktur') + '\n';
        let lvi = 'Lenfatik ve/veya venöz invazyon: ' + t.lvInvasion;
        if (t.lvInvasion === 'VARDIR'){
          lvi += '. Lenfatik invazyon ' + (t.lymphaticInvasion ? 'VARDIR' : 'yoktur') +
                 '. Anjioinvazyon ' + (t.angioinvasion ? 'VARDIR' : 'yoktur') + '.';
        }
        text += indent + lvi + '\n';
        text += indent + 'Perinöral invazyon: ' + (t.perineuralInvasion ? 'VARDIR' : 'yoktur') + '\n';
        if (t.mitoticActivity && t.mitoticActivity !== '0'){ text += indent + 'Mitotik Oran: ' + t.mitoticActivity + ' / 2 mm²\n'; }
        else { text += indent + 'Mitotik aktivite: yoktur\n'; }
        text += indent + 'Nekroz: ' + (t.necrosis ? 'izlendi' : 'yoktur') + '\n';
        return text;
      }
      function generateReportText(){
        let report = '';
        const s = state;
        report += s.specimenType + ':\n';
        const maxSize = s.tumors.length ? Math.max.apply(null, s.tumors.map(t => t.size)) : 0;
        const mainDx = getTumorDiagnosisName(maxSize);
        report += mainDx + '\n';
        if (s.freeNote && s.freeNote.trim()) report += s.freeNote.trim() + '\n';

        if (s.tumors.length === 1){
          const t = s.tumors[0];
          if (t.location) report += 'Tümör ' + t.location + ' yerleşimlidir.\n';
          report += 'Tümör çapı ' + t.size + ' mm\n';
          if (t.subtypes.length) report += 'Tümör ' + t.subtypes.join(' ve ') + ' histolojisindedir.\n';
          if (t.sample) report += 'Örnek No: ' + t.sample + '\n';
          report += '\n' + generateFindingsText(t);
        } else if (s.tumors.length > 1){
          report += 'Tümör Odaklılığı: ' + s.tumors.length + ' odaklıdır. Multifokal tümör VARDIR.\n\n';
          report += 'Tümör odakları:\n';
          s.tumors.forEach((t,i) => {
            const dx = getTumorDiagnosisName(t.size);
            report += (i+1) + '. Tümör: ' + dx + '\n';
            report += '- Yerleşim: ' + t.location + '\n';
            report += '- Çap: ' + t.size + ' mm\n';
            report += '- Histoloji: ' + t.subtypes.join(' ve ') + '\n';
            if (t.sample) report += '- Örnek No: ' + t.sample + '\n';
            report += generateFindingsText(t, '  ');
            report += '\n';
          });
        }

        // Lenf nodları (tümörlerden sonra)
        if (s.lymphNodes.length){
          report += '\nLenf nodları:\n';
          s.lymphNodes.forEach(ln => {
            if (ln.metastatic > 0){
              report += (ln.location ? ln.location + '  ' : '') + ln.total + ' lenf nodunun ' + ln.metastatic + "'inde metastaz VARDIR (" + ln.metastatic + '/' + ln.total + '). ';
            } else {
              report += (ln.location ? ln.location + '  ' : '') + ln.total + ' adet reaktif lenf nodu vardır (0/' + ln.total + '). ';
            }
            report += 'Perikapsüler invazyon ' + (ln.pericapsularInvasion ? 'VARDIR' : 'yoktur') + '.\n';
          });
        }

        if (s.backgroundThyroid.length){
          report += '\nTümör dışı tiroid: ' + s.backgroundThyroid.join(', ') + '\n';
        }
        return collapseTripleNewlines(report.trim());
      }

      // ------------ MAIN ------------
      function renderReport(){ reportPreview.textContent = generateReportText(); }
      function render(){
        renderChips();
        renderControls();
        attachScrollListenerOnce();
        renderReport();
        // chips aktiflikleri (ilk durumda)
        if (state.activeTumorId != null) setActiveTumorChip(state.activeTumorId);
        if (state.activeLnId != null) setActiveLnChip(state.activeLnId);
      }

      function copyReport(){
        const txt = reportPreview.textContent;
        if (!txt) return;
        navigator.clipboard.writeText(txt).then(() => {
          copyReportBtn.innerHTML = '<i class="fa-solid fa-check"></i> Kopyalandı!';
          setTimeout(() => { copyReportBtn.innerHTML = '<i class="fa-solid fa-copy"></i> Kopyala'; }, 1600);
        }, () => { alert('Rapor kopyalanamadı.'); });
      }
      copyReportBtn.addEventListener('click', copyReport);

      render();
    </script>
  </body>
</html>
